# Keycloak Theme - FinanceFlow

A beginner-friendly guide to how our custom Keycloak login pages and emails work.

---

## What Problem Does This Solve?

When a user opens FinanceFlow, they get redirected to Keycloak for login. By default, Keycloak shows its own generic login page â€” it looks completely different from our app. That's a bad experience. Imagine walking into a fancy restaurant and being asked to sign in through a gas station door.

This theme makes the Keycloak login pages **look exactly like our app** â€” same colors, fonts, buttons, and card layout.

---

## How It Works (The Big Picture)

```
User opens FinanceFlow
        |
        v
Not logged in? â†’ Keycloak shows LOGIN PAGE
        |
        v
Keycloak looks for a theme called "financeflow"
        |
        v
Finds our custom theme in a JAR file
        |
        v
Renders OUR React components instead of the default page
```

**In simple terms:** We wrote React components for the login page, registration page, etc. Then we compiled them into a special file (a `.jar` file) that Keycloak understands. Keycloak uses our file instead of its default design.

---

## What is Keycloakify?

**Keycloakify** is a tool that lets us build Keycloak themes using React â€” the same technology we use for the main app. Without Keycloakify, we'd have to write Keycloak themes using an old template language called FreeMarker, which is completely different from our React codebase.

**Real-world analogy:** Keycloakify is like a translator. We speak React, Keycloak speaks FreeMarker. Keycloakify translates our React code into something Keycloak understands.

---

## Project Structure

```
keycloak-theme/
â”œâ”€â”€ package.json            â† Dependencies (React, Keycloakify, Tailwind)
â”œâ”€â”€ vite.config.ts          â† Build config (tells Keycloakify our theme is called "financeflow")
â”œâ”€â”€ tailwind.config.ts      â† Same Tailwind config as the main app
â”œâ”€â”€ tsconfig.json           â† TypeScript config
â”œâ”€â”€ index.html              â† HTML entry point (required by Vite)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.tsx            â† Entry point (Keycloakify injects context here)
â”‚   â”œâ”€â”€ index.css           â† Same CSS variables as the main app (colors, fonts)
â”‚   â”œâ”€â”€ kc.gen.tsx          â† AUTO-GENERATED by Keycloakify (don't edit!)
â”‚   â”‚
â”‚   â”œâ”€â”€ components/ui/      â† Copied from frontend (Button, Input, Card, Label)
â”‚   â”œâ”€â”€ lib/utils.ts        â† The cn() utility (copied from frontend)
â”‚   â”‚
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”œâ”€â”€ KcPage.tsx      â† ROUTER â€” decides which page to show
â”‚   â”‚   â”œâ”€â”€ KcContext.ts    â† TypeScript types for Keycloak data
â”‚   â”‚   â”œâ”€â”€ i18n.ts         â† Internationalization setup
â”‚   â”‚   â”œâ”€â”€ main.css        â† Imports index.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ AuthLayout.tsx   â† Shared layout (logo + centered card)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ pages/
â”‚   â”‚       â”œâ”€â”€ Login.tsx              â† Login page
â”‚   â”‚       â”œâ”€â”€ Register.tsx           â† Registration page
â”‚   â”‚       â”œâ”€â”€ LoginResetPassword.tsx â† "Forgot password?" page
â”‚   â”‚       â”œâ”€â”€ LoginUpdatePassword.tsx â† "Set new password" page
â”‚   â”‚       â””â”€â”€ Error.tsx              â† Error page
â”‚   â”‚
â”‚   â””â”€â”€ email/
â”‚       â”œâ”€â”€ theme.properties           â† Tells Keycloak this extends the base email theme
â”‚       â”œâ”€â”€ html/                      â† HTML email templates
â”‚       â”‚   â”œâ”€â”€ template.ftl           â† Shared email layout (header, card, footer)
â”‚       â”‚   â”œâ”€â”€ password-reset.ftl     â† Password reset email
â”‚       â”‚   â”œâ”€â”€ email-verification.ftl â† Email verification email
â”‚       â”‚   â””â”€â”€ executeActions.ftl     â† Admin-triggered action email
â”‚       â””â”€â”€ text/                      â† Plain-text fallback versions
â”‚           â”œâ”€â”€ password-reset.ftl
â”‚           â”œâ”€â”€ email-verification.ftl
â”‚           â””â”€â”€ executeActions.ftl
â”‚
â””â”€â”€ dist_keycloak/          â† BUILD OUTPUT (the JAR files Keycloak uses)
```

---

## How We Installed It

### Step 1: Created a new project

We created the `keycloak-theme/` directory with its own `package.json`, separate from the main frontend. This keeps things clean â€” the theme is its own mini-project.

```bash
cd keycloak-theme
npm install
```

This installs: `keycloakify`, `react`, `tailwindcss`, and the same UI libraries we use in the main app (`clsx`, `tailwind-merge`, `class-variance-authority`, `lucide-react`, `@radix-ui/react-label`, `@radix-ui/react-slot`).

### Step 2: Copied our design system

We copied these files from `frontend/` so the theme looks identical:

| What | Why |
|------|-----|
| `index.css` | Our color palette (blue primary, light background, etc.) |
| `tailwind.config.ts` | Tailwind knows about our custom colors |
| `components/ui/button.tsx` | Same button style |
| `components/ui/input.tsx` | Same input fields |
| `components/ui/card.tsx` | Same card containers |
| `components/ui/label.tsx` | Same form labels |
| `lib/utils.ts` | The `cn()` helper for combining CSS classes |

### Step 3: Configured Keycloakify

In `vite.config.ts`, we told Keycloakify:
- Our theme is called `"financeflow"`
- We don't need an account theme (only login)

---

## How We Configured It

### The Router (`KcPage.tsx`)

This is the brain of the theme. When Keycloak needs to show a page, it passes a `pageId` (like `"login.ftl"`). Our router decides which React component to render:

```
"login.ftl"                  â†’ Login.tsx
"register.ftl"               â†’ Register.tsx
"login-reset-password.ftl"   â†’ LoginResetPassword.tsx
"login-update-password.ftl"  â†’ LoginUpdatePassword.tsx
"error.ftl"                  â†’ Error.tsx
anything else                â†’ Keycloakify's default page
```

### The Layout (`AuthLayout.tsx`)

Every page wraps its content in `AuthLayout`, which provides:
- Full-screen light background
- FinanceFlow logo with wallet icon
- Centered card (max 448px wide)
- Fade-in animation

### Connecting to Keycloak (Docker)

In `docker-compose.yml`, we mount the built JAR file into Keycloak's providers directory:

```yaml
volumes:
  - ./keycloak-theme/dist_keycloak/keycloak-theme-for-kc-all-other-versions.jar:/opt/keycloak/providers/financeflow-theme.jar
```

In `keycloak/realm-export.json`, we tell the realm to use our theme:

```json
{
  "loginTheme": "financeflow",
  "emailTheme": "financeflow"
}
```

---

## How Pages Were Customized

Each page receives a `kcContext` object from Keycloak containing everything it needs â€” form URLs, field values, error messages, realm settings, etc.

**Example: How the Login page works**

1. Keycloak passes `kcContext` with:
   - `url.loginAction` â€” where the form submits to
   - `login.username` â€” previously entered username
   - `realm.resetPasswordAllowed` â€” whether to show "Forgot password?"
   - `realm.registrationAllowed` â€” whether to show "Create account" link
   - `messagesPerField` â€” validation errors per field

2. Our `Login.tsx` renders a form that POSTs to `url.loginAction`:
   ```html
   <form action={url.loginAction} method="post">
     <input name="username" />
     <input name="password" />
     <button type="submit">Sign in</button>
   </form>
   ```

3. Keycloak handles the actual authentication. We just provide the UI.

**Real-world analogy:** Think of it like a restaurant menu. Keycloak is the kitchen â€” it handles all the cooking (authentication). Our theme is just the menu design â€” it decides how things look, but the kitchen does the real work.

---

## What is the Email Server (Mailpit)?

When a user clicks "Forgot password?", Keycloak needs to send them an email with a reset link. In production, you'd use a real email service (like Gmail SMTP or SendGrid). But in development, we use **Mailpit** â€” a fake email server that catches all emails locally.

**Real-world analogy:** Mailpit is like a mailbox in your house that catches all outgoing letters before they leave. You can read them, but they never actually get sent anywhere.

### How it's set up

In `docker-compose.yml`:
```yaml
mailpit:
  image: axllent/mailpit:latest
  ports:
    - "8025:8025"   # Web UI to read emails
    - "1025:1025"   # SMTP port (where Keycloak sends emails)
```

In `realm-export.json`:
```json
"smtpServer": {
  "host": "mailpit",
  "port": "1025",
  "from": "noreply@financeflow.local",
  "fromDisplayName": "FinanceFlow"
}
```

### How to use it

1. Trigger a password reset on the login page
2. Open **http://localhost:8025** in your browser
3. You'll see the email with your custom FinanceFlow design

---

## How Email Templates Work

Email templates are different from login pages. They use **FreeMarker** (`.ftl` files) with inline HTML/CSS â€” not React. This is because emails need to work in Gmail, Outlook, Apple Mail, etc., which don't support JavaScript.

### The shared layout (`template.ftl`)

Every email wraps its content using the `template.ftl` layout macro:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Light background (#F8FAFC)     â”‚
â”‚                                     â”‚
â”‚         ğŸ’° FinanceFlow              â”‚
â”‚                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚  White card with border â”‚      â”‚
â”‚    â”‚                         â”‚      â”‚
â”‚    â”‚  [Email content here]   â”‚      â”‚
â”‚    â”‚                         â”‚      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚    Automated message footer         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Template variables

Keycloak injects variables into templates:

| Variable | What it contains |
|----------|-----------------|
| `${link}` | The action URL (reset link, verify link) |
| `${linkExpiration}` | How many minutes until the link expires |
| `${realmName}` | "financeflow" |
| `${firstName}` | User's first name |

---

## How to Make Future Changes

### Changing login page styling

1. Edit files in `keycloak-theme/src/login/pages/`
2. Rebuild and restart:

```bash
cd keycloak-theme
npm run build-keycloak-theme
```

Then restart Keycloak:

```bash
# From the frontend/ directory:
npm run keycloak:down && npm run keycloak:up
```

### Adding a new custom page

1. Create a new file in `keycloak-theme/src/login/pages/` (e.g., `LoginOtp.tsx`)
2. Add a `case` in `KcPage.tsx`:
   ```tsx
   case "login-otp.ftl":
     return <LoginOtp kcContext={kcContext} i18n={i18n} />;
   ```
3. Rebuild and restart

### Changing colors or fonts

Edit `keycloak-theme/src/index.css` â€” the CSS variables at the top control all colors:

```css
--primary: 217 71% 53%;        /* Blue buttons and links */
--background: 210 20% 98%;     /* Page background */
--destructive: 0 72% 51%;      /* Error messages */
```

### Changing email templates

1. Edit files in `keycloak-theme/src/email/html/` (HTML) and `src/email/text/` (plain text)
2. Remember: always update **both** HTML and text versions
3. Rebuild and restart

### Testing emails locally

1. Make sure Docker is running (`npm run keycloak:up` from frontend/)
2. Trigger an email action (password reset, etc.)
3. Open **http://localhost:8025** to see the email in Mailpit

---

## Quick Reference Commands

| Action | Command |
|--------|---------|
| Install dependencies | `cd keycloak-theme && npm install` |
| Build theme JAR | `cd keycloak-theme && npm run build-keycloak-theme` |
| Build from frontend/ | `npm run keycloak:build-theme` |
| Start Keycloak + Mailpit | `npm run keycloak:up` (from frontend/) |
| Stop Keycloak + Mailpit | `npm run keycloak:down` (from frontend/) |
| View caught emails | Open http://localhost:8025 |
| Keycloak admin console | Open http://localhost:8180/admin (admin/admin) |

---

## Gotchas and Tips

1. **"Theme not applied?"** â€” If the realm already existed, the `realm-export.json` import is skipped. Set the theme manually via the Keycloak admin console: Realm Settings â†’ Themes.

2. **"I changed a file but nothing changed?"** â€” You need to rebuild the JAR and restart Keycloak. The JAR is a compiled bundle â€” Keycloak doesn't read your source files directly.

3. **"kc.gen.tsx has errors?"** â€” Don't edit that file! It's auto-generated by Keycloakify during the build process.

4. **"My new page shows the old Keycloak design?"** â€” You haven't added a `case` for it in `KcPage.tsx`. Un-customized pages fall back to Keycloakify's default rendering.

5. **"Email looks broken in Outlook?"** â€” Use inline `style=""` attributes, not CSS classes. Email clients are stuck in 2005. Avoid flexbox, grid, or modern CSS.
